[[retail.deploy_terminals_other]]
= Deploy Terminals - Other Methods


If you are not able to boot terminals from the network, you can create a live USB image and deploy terminals using a removable USB storage device.

You can also bootstrap terminals across a wireless network.

[IMPORTANT]
====
After you have registered new terminals, always check the {susemgr} {webui} to ensure your terminals have connected successfully to the branch server, and not directly to the {susemgr} Server by mistake.
====



== Deploy Terminals with a Removable USB Device

If you do not want to boot terminals from the network, you can create a live USB image and deploy terminals using a removable USB storage device.
This is useful if you cannot boot your terminals from the network, or if you do not have a local {smr} branch server providing network services.

You can prepare a bootable USB device with the image and tools required to deploy a POS terminal using a remote {smr} branch server.
POS devices booted using the USB device are assigned to the {smr} branch server that created the USB device.

You can create the bootable USB device on the branch server directly, or on the {smr} Server.



.Procedure: Creating a Bootable USB Device
. On the {smr} branch server, at the command prompt, as root, create the POS image.
You need to specify the size of the image, in megabytes.
Ensure you allow at least 300{nbsp}MB:
+
----
salt-call image_sync_usb.create <usb image name> <size in MB>
----
. Insert the USB device into the {smr} branch server machine, and copy the image to the new location:
+
----
dd if=<usb image name> of=<path to usb device>
----


When you have the image on the USB drive, check that the terminals you want to deploy allow local booting.
You can check this by editing the Saltboot formula in the {smr} {webui}.
For more information about the Saltboot formula, see xref:salt:formula-saltboot.adoc[].



.Procedure: Deploying Images to the Terminals using USB
. Insert the USB device into the terminal.
. Power on the POS terminal.
. Boot from the USB device to begin bootstrapping.



== Bootstrap Terminals over a Wireless Network

For terminals that cannot be connected directly to the network, you can bootstrap them over a wireless network.
Bootstrapping over a wireless network does not support PXE booting, so you must perform the initial booting and initialization of the wireless connection on the terminal using a USB device.

[[WARNING]]
====
Bootstrapping across a wireless network could expose a security risk.
The boot ``initrd`` image and the partition that contains ``/etc/salt`` must be stored unencrypted on the terminal.
This allows {smr} to set up the wireless network.
If this breaches your security requirements, you will need to use a separate production network, with network credentials managed by Salt, so that credentials are not stored on the terminal unencrypted.
====



Note: For best results, enable local boot in partitioning. See https://opensource.suse.com/doc-susemanager/suse-manager/salt/formula-saltboot.html#saltboot-formula-partition-types

## Prepare Wireless bootstrap

### Procedure Prepare WiFi enabled boot image
1) Enable `dracut-wireless` package during OS Image build.

2) Provide wireless credential (optional).
    This is useful if same wireless credentials are used across organization.
    Note: This will use same wireless credentials for bootstrap, boot phase and also during production (regular system run).
    1) Add file `etc/sysconfig/network/ifcfg-wlan0` to the OS Image template containing:
        ```bash
        # ALLOW_UPDATE_FROM_INITRD
        WIRELESS_ESSID=<wireless network name>
        WIRELESS_WPA_PSK=<wireless network password>
        ```
        Note: If you wish to use different credentials for bootstrapping and regular system run, remove the comment `# ALLOW_UPDATE_FROM_INITRD` above. Otherwise system image wireless credentials will be updated from those used in boot image.
    2) Build the image as usual way

3) Provide WiFi enabled boot image to the terminal.
  * Use USB booting feature and boot terminal from this USB stick
    Note: When creating USB boot image on branch server, Wifi enabled boot image must be already synchronized to the branch server and selected as default boot image.
  * Preload boot image to the terminal before shipping to the location and bootstrapping.

### Providing wireless credentials outside of image build
  * Add credentials to already existing boot image build with `dracut-wireless`
     This is useful for updating images per branch server if there are different credentials per branch server
    1) On the branch server create `./etc/sysconfig/network/ifcfg-wlan0`
        ```bash
        WIRELESS_ESSID=<wireless network name>
        WIRELESS_WPA_PSK=<wireless network password>
        ```
    2) Add created file to existing initrd
        ```bash
        echo ./etc/sysconfig/network/ifcfg-wlan0 | cpio -H newc -o | gzip >> /srv/saltboot/boot/initrd.gz
        ```

  * Specify WIRELESS_ESSID and WIRELESS_WPA_PSK on kernel command line when the terminal is booting
      This is useful for testing new credentials or when deploying small number of terminals.
      Note: Terminal will remember new credentials after successful boot.

## Changing Wireless Credentials

Changing of wireless credentials is possible in multiple ways.
Depends on if one company wide network is used, or if each branch have its own network.
If on top different network is used for boot phase and different for production, following examples may need to be adapted to fit particular scenarios.

* Rebuild boot image with updated password.
  This is suitable if only one company wide network is used.
  * Update WIRELESS_ESSID and WIRELESS_WPA_PSK in image template and rebuild the image
  * Recreate new bootable USB stick based on new boot image
  * Boot terminal from new USB stick

* Update WiFi credentials on running system without redeploying terminal using salt
  This is suitable if there are different credentials across the infrastructure.
  Note: If you are using separate network for boot phase, managed file may need to be renamed or extended to cover `/etc/sysconfig/network/initrd-ifcfg-wlan0` as well.
  *  Create a salt state `/srv/salt/update-terminal-credentials.sls` to maintain `/etc/sysconfig/network/ifcfg-wlan0` on running terminal
    ```salt
    /etc/sysconfig/network/ifcfg-wlan0
      file.managed:
        - contents: |
              WIRELESS_ESSID=<wireless network name>
              WIRELESS_WPA_PSK=<wireless network password>
      # regenerate initrd
      cmd.run:
         - name: 'mkinitrd'
    ```
  * Apply your state to the terminal
    ```bash
    salt <terminal_salt_name> state.apply update-terminal-credentials
    ```

## Advanced usage

### Use different wireless networks for bootstrap and for system
* Manage production wireless credentials in salt.
  Write custom salt state named `saltboot_hook` to provide custom `/etc/sysconfig/network/ifcfg-wlan0` to the system image during boot.
   ```salt
   {% set root = salt['environ.get']('NEWROOT') %}
   {{ root }}/etc/sysconfig/network/ifcfg-wlan0:
     file.managed:
       - source:
         - <salt://any/file>
       - require:
         - saltboot: saltboot_fstab
       - require_in:
         - saltboot: boot_system
   ```
  This hook is applied (if present) after system image is deployed.

* Use boot image specific version of ifcfg name `/etc/sysconfig/network/initrd-ifcfg-wlan0`.
   File `/etc/sysconfig/network/initrd-ifcfg-wlan0` can be provided for image build or maintained by salt on running system to provide wireless credentials used only for bootstrap and boot phase.

Note: Boot phase supports only WPA2 PSK wireless configuration, salt-managed production configuration can support all features supported by used operating system.